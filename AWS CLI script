cat > ec2-automation.sh << 'EOF' && chmod +x ec2-automation.sh && ./ec2-automation.sh
#!/bin/bash

# Script to launch EC2 instance, create AMI, and launch from AMI
echo "Starting EC2 automation script"

# Creating original EC2 instance
INSTANCE_ID=$(aws ec2 run-instances \
  --image-id ami-0360c520857e3138f \
  --count 1 \
  --instance-type t2.micro \
  --key-name Level-Up-Key \
  --security-group-ids sg-048b5eaf777063444 \
  --associate-public-ip-address \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Apache-Server}]' \
  --user-data '#!/bin/bash
curl -fsSL https://raw.githubusercontent.com/WE10GRAD/EC2-Instance-Launch-and-AMI-Image-Script/main/Main_Script | bash' \
  --query 'Instances[0].InstanceId' --output text)

echo "Created instance: $INSTANCE_ID"

# Wait for instance to be ready
aws ec2 wait instance-running --instance-ids $INSTANCE_ID

# Create AMI from the instance
echo "Creating AMI"
AMI_ID=$(aws ec2 create-image \
  --instance-id $INSTANCE_ID \
  --name "Apache-AMI" \
  --query 'ImageId' --output text)

# Wait for AMI to be ready
aws ec2 wait image-available --image-ids $AMI_ID


# Launch new instance from custom AMI
echo "Launching new instance from AMI"
AMI_LAUNCH=$(aws ec2 run-instances \
  --image-id $AMI_ID \
  --count 1 \
  --instance-type t2.micro \
  --key-name Level-Up-Key \
  --security-group-ids sg-048b5eaf777063444 \
  --associate-public-ip-address \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=AMI-Copy-Server}]' \
  --query 'Instances[0].InstanceId' --output text)

echo "New instance created: $AMI_LAUNCH"
EOF
